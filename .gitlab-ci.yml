
.kaniko-build:
  only:
    refs:
      - branches
      - master
      - push
  tags:
    - docker
  stage: docker-images
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - |
        echo "-----BEGIN CERTIFICATE-----
        MIIFJTCCAw2gAwIBAgIUMI0Z8YSLeRq8pZks40O3Dq2m8TIwDQYJKoZIhvcNAQEL
        BQAwGjEYMBYGA1UEAxMPRXZlcm55bSBSb290IENBMB4XDTE3MTAxMTIwMTAxMFoX
        DTQ3MTAwNDIwMTAzOVowGjEYMBYGA1UEAxMPRXZlcm55bSBSb290IENBMIICIjAN
        BgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEA1kjmtmMfLJfsqUNaco44N3brW8Vu
        b02lAeEwbxc65mwfAG8kAjW7kYhI/fDXFOYXUvoa3Dg7bFeEatdIjHOahZssGM27
        HsQZ4PfRhPE6HtXFszmDwXWuEekVxoyueTqL7ExnNZ+BRTXvPfm5nw1E7L3o3xHF
        GSOtWFCyHfKd1LwMKzAVSjxlawEZnfk3WK3NxrC4UYMlQaDme7m3rCMfO+KBQk69
        bFXsgn6/EihVeQ8T1+T8gogofzh5b4Z7kS6e6GMqotbGFg4agejkRVsIglSpaQLk
        2Ztn/MP1dwgyvO4uvplB4sxZSC2FhhovlwPETmbKsnpj020+m0+YU4FPKwjroMiH
        tP//YqiNKsLxtjhffW7XFToyy0qQttW5RMWnyx4MXs9Hwcy29gY1izeGMSzz3zV5
        HG8JSJikuYbYiGJRVS0egovkVjja6lrVk0Q4Hm5pbw4l7LYCd6bkDLMsRaS1QnWs
        9iz6XEf5SpIu1FuqHmlhj1ABehUyGIg5oC6egML3q78yk0mCW523qMFa9Kjnk871
        mmXSCn3p/3DCrwWYfpcibxtVaKyJj6ISYIcl+Zu65Uzmhf+nj56x3gkNgEOva7JS
        Xge+FxPxsaXBGyeSH09nNIoNmh/UucuzpNY2UyCpJuqXHtR5jaACSdsqNxG8tcDg
        K9v98D/DFiShghECAwEAAaNjMGEwDgYDVR0PAQH/BAQDAgEGMA8GA1UdEwEB/wQF
        MAMBAf8wHQYDVR0OBBYEFOrH4oUpB94gNDNqdGG92kdVZ3qkMB8GA1UdIwQYMBaA
        FOrH4oUpB94gNDNqdGG92kdVZ3qkMA0GCSqGSIb3DQEBCwUAA4ICAQCwjN3ggZ98
        BXT39fKkCX3FHb0++aFcIyMKWrcZIpYrl3GoZsNKZK4QNQ+uJOP8xmqgyrCoMfch
        VIGPQ0RDN/IzqCLhc/U3pDmk2hXa3xTxD3gpCQZ6Bz04KlcLfZd5jzbI741bVDyF
        a1n46bEyuqV4SsNJWI/FGokJCNcZH66njBQBaQAccZ7xB9vWU9yjIYtGQDDvSm6J
        SC2knrQri0vv4QLUSc1LS6AlWWSQxcCpcdO+OzIFGsf5bVmYN6J4R3COY5NyQ+yn
        pOSN2NOh5h3ZrYAxm3i4Il0orVLveVcTVDGeAgZUII4YLJi/01RHGqit3aCuApSh
        bzFTZ5FldFss+JX9iAhqpFDbHLgae0F3QmYEnGilt/PzO4j23QJo3FZKeruQLH7P
        L9aOgN6S2+Akbbm9YTc59yzU5TZMxANwTdaYFWFqk/8nKgZiBR1l8jnWTlWnm86A
        qVssH3DLKwiYrWSOHRzGuN5BmPXxxtKQJlwAXt0wJE3puUkaJSRo7CJQ3QNMoKDe
        OjzXc9WvkFIXr3Eui8UTiHB/WT7N4o8hmVN404akGfWE0YNwRVfWpjGdew6g0tZi
        lFnjUUk49av67um43JHcinT5NFPuleZzkjaL/D8ueOrjXQDy05rwVdgmw9pXog4B
        Tw6APXtEnjfD2H8HOpOX/7ef4gWK0O1Q7A==
        -----END CERTIFICATE-----" >> /kaniko/ssl/certs/ca-certificates.crt
    - eval $DOCKER_PREP_COMMAND
    - /kaniko/executor --context $DOCKER_CONTEXT --dockerfile $DOCKERFILE_PATH --destination $CI_REGISTRY_IMAGE/$DOCKER_IMAGE_NAME:$CI_COMMIT_TAG

stages:
  - docker-images
  - dependent-docker-images
  - unit-tests
  - integration-tests
  - build
  - deploy

.tags:
  tags:
    - docker

buildenv-docker-build:
  extends: .kaniko-build
  only:
    changes:
      - devops/dockerfiles/buildenv.dockerfile
  variables:
    DOCKERFILE_PATH: '$CI_PROJECT_DIR/devops/dockerfiles/buildenv.dockerfile'
    DOCKER_IMAGE_NAME: 'buildenv'
    DOCKER_CONTEXT: '$CI_PROJECT_DIR'
    DOCKER_PREP_COMMAND: 'echo none'

verity-server-docker-build:
  extends: .kaniko-build
  only:
    changes:
      - server/devops/dev/verity-server.dockerfile
    refs:
      - "master"
  variables:
    DOCKERFILE_PATH: '$CI_PROJECT_DIR/server/devops/dev/verity-server.dockerfile'
    DOCKER_IMAGE_NAME: 'verity-server'
    DOCKER_CONTEXT: '$CI_PROJECT_DIR/server'
    DOCKER_PREP_COMMAND: 'echo none'

autorespond-docker-build:
  extends: .kaniko-build
  stage: dependent-docker-images
  only:
    changes:
      - devops/dockerfiles/buildenv.dockerfile
      - devops/dockerfiles/auto-respond-client.dockerfile
  variables:
    DOCKERFILE_PATH: '$CI_PROJECT_DIR/devops/dockerfiles/auto-respond-client.dockerfile'
    DOCKER_IMAGE_NAME: 'autorespond'
    DOCKER_CONTEXT: '$CI_PROJECT_DIR'
    DOCKER_PREP_COMMAND: sed 's~FROM buildenv~FROM $CI_REGISTRY_IMAGE/buildenv~g' -i devops/dockerfiles/auto-respond-client.dockerfile

unit-tests-and-syntax:
  stage: unit-tests
  image: $CI_REGISTRY_IMAGE/buildenv:latest
  extends: .tags
  script:
    - cd sdk/java-sdk/ && mvn test && cd - # Java SDK unit tests
    - cd server && npm run lint && cd - # Mock Verity linting

java-sdk-integration-tests:
  stage: integration-tests
  image: $CI_REGISTRY_IMAGE/buildenv:latest
  extends: .tags
  services:
    - name: $CI_REGISTRY_IMAGE/autorespond:latest
      alias: autorespond
    - name: $CI_REGISTRY_IMAGE/verity-server-image:latest
      alias: mock-verity
      command: ["000000000000000000000000Trustee1", "https://eas-team1.pdev.evernym.com"]
  script:
    - cd sdk/java-sdk && mvn package -DskipTests && cd -
    - cd sdk/java-sdk/example && mvn package && cd -
    - python3 -m pip install -r tools/requirements.txt
      # - sleep 60 # Wait for mock verity to come up.
    - ./tools/provision_sdk.py --wallet-name test-wallet http://mock-verity:8080 12345 > sdk/java-sdk/example/verityConfig.json
    - ./sdk/java-sdk/devops/integration_tests.sh

make_jar:
  stage: build
  image: $CI_REGISTRY_IMAGE/buildenv:latest
  extends: .tags
  script:
    - sed -i 's/-SNAPSHOT<\/version>/<\/version>/g' sdk/java-sdk/pom.xml
    - cd sdk/java-sdk/ && mvn package -DskipTests
  artifacts:
    paths:
      - sdk/java-sdk/target/java-sdk*.jar
    expire_in: 1 week

verity-server-image-docker-build:
  extends: .kaniko-build
  stage: dependent-docker-images
  only:
    changes:
      - server/*
      - server/devops/dev/verity-server.dockerfile
      - server/devops/dev/verity-server-image.dockerfile
    refs:
      - "master"
  dependencies:
    - verity-server-docker-build
  variables:
    DOCKERFILE_PATH: '$CI_PROJECT_DIR/server/devops/dev/verity-server-image.dockerfile'
    DOCKER_IMAGE_NAME: 'verity-server-image'
    DOCKER_CONTEXT: '$CI_PROJECT_DIR/server'
    DOCKER_PREP_COMMAND: sed 's~FROM verity-server~FROM $CI_REGISTRY_IMAGE/verity-server~g' -i server/devops/dev/verity-server-image.dockerfile

upload_to_maven:
  stage: deploy
  image: $CI_REGISTRY_IMAGE/buildenv:latest
  extends: .tags
  script:
    - ./devops/scripts/maven/upload.sh
  dependencies:
    - make_jar
  when: on_success
  only:
    refs:
      - "master@dev/verity/verity-sdk"
    changes:
      - sdk/java-sdk/*

update_getting_started_guide:
  stage: deploy
  image: $CI_REGISTRY_IMAGE/buildenv:latest
  extends: .tags
  script:
    - ./devops/scripts/update_getting_started_repo.sh
  dependencies:
  when: on_success
  only:
    refs:
      - "master@dev/verity/verity-sdk"
